name: MiniFB CMake Build

on: # Manual only
  workflow_dispatch:
    inputs:
      target_os:
        description: 'Select the operating system to build for'
        required: true
        default: 'windows-latest'
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ github.event.inputs.target_os }}

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    # ---------------------------
    #      CMAKE BUILD STEP
    # ---------------------------
    - name: Install Ubuntu Dependencies
      if: github.event.inputs.target_os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libx11-dev \
            libxkbcommon-dev \
            libgl1-mesa-dev

    - name: Configure CMake Arguments
      id: cmake_args
      shell: bash # Use bash for robust conditional logic across all OSes
      run: |
        # Common flags
        INSTALL_DIR="${{ github.workspace }}/install"
        CMAKE_FLAGS="-DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR"

        if [ "${{ github.event.inputs.target_os }}" == "ubuntu-latest" ]; then
          # Ubuntu: Use OpenGL and specifically disable Wayland
          CMAKE_FLAGS="$CMAKE_FLAGS -DUSE_OPENGL_API=ON -DUSE_WAYLAND_API=OFF"
        elif [ "${{ github.event.inputs.target_os }}" == "macos-latest" ]; then
          # macOS: Omit OpenGL and use Metal
          CMAKE_FLAGS="$CMAKE_FLAGS -DUSE_METAL_API=ON"
        else
          # Windows: Default flags, potentially including OpenGL if needed
          CMAKE_FLAGS="$CMAKE_FLAGS -DUSE_OPENGL_API=ON"
        fi
        
        # Output the flags for the next step to use
        echo "flags=$CMAKE_FLAGS" >> $GITHUB_OUTPUT

    - name: CMake Action
      uses: threeal/cmake-action@v2.1.0
      with:
        source-dir: minifb-repo
        build-dir: build

        args: ${{ steps.cmake_args.outputs.flags }}
        run-build: true
        build-args: --config Release --target install

    # ---------------------------
    #   STORE RESULTS IN REPO
    # ---------------------------
    - name: Commit build outputs back into the same branch
      shell: bash
      run: |
        git config user.name "github-actions-by-${{ github.actor }}"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        OUTDIR="ci_builds/${{ github.event.inputs.target_os }}"
        
        rm -rf "$OUTDIR"
        mkdir -p "$OUTDIR"
        cp -r install/* "$OUTDIR"/.
        git add --force -A "$OUTDIR"

        if git diff --cached --quiet; then
          echo "No changes to commit. Exiting"
          exit 0
        fi

        echo "Changes detected! Proceeding with clean and commit."

        git commit -m "Manual CI build (${{ github.event.inputs.target_os }})"
        git fetch
        git push --force-with-lease "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" HEAD:$(git rev-parse --abbrev-ref HEAD)
