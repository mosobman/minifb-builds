name: MiniFB CMake Build

on:
  workflow_dispatch:   # Manual only

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ---------------------------
    #      CMAKE BUILD STEP
    # ---------------------------
    - name: CMake Action
      uses: threeal/cmake-action@v2.1.0
      with:
        source-dir: minifb-repo
        build-dir: build

        # Valid inputs exactly as the action defines
        args: >
          -DCMAKE_BUILD_TYPE=Release
          -DUSE_OPENGL_API=ON

        run-build: true
        build-args: --config Release

    # ---------------------------
    #   STORE RESULTS IN REPO
    # ---------------------------
    - name: Commit build outputs back into the same branch
      shell: bash
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        OUTDIR="ci_builds/${{ matrix.os }}"
        mkdir -p "$OUTDIR"
        cp -r build/* "$OUTDIR"/

        git add "$OUTDIR"

        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git commit -m "Manual CI build (${{ matrix.os }})"
        git push
